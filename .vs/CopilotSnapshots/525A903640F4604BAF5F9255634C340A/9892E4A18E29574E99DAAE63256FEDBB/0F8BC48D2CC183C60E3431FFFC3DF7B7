using rpg_deneme.Core;
using rpg_deneme.Data;
using rpg_deneme.Models;
using System;
using System.Collections.Generic;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using static rpg_deneme.Core.Enums;

namespace rpg_deneme.Business
{
    public class ZoneManager
    {
        private ZoneRepository _repo = new ZoneRepository();
        private CharacterRepository _charRepo = new CharacterRepository();

        public List<ZoneModel> GetAvailableZones(CharacterModel hero)
        {
            if (hero.MaxUnlockedZoneID < 1) hero.MaxUnlockedZoneID = 1;
            var zones = _repo.GetZones(); // Repository'deki mevcut metot
            foreach (var z in zones) z.IsUnlocked = (z.ZoneID <= hero.MaxUnlockedZoneID);
            return zones;
        }

        public EnemyModel GetEnemyForZone(int zoneId, bool spawnBoss)
        {
            if (spawnBoss) return _repo.GetBossForZone(zoneId); // Repository'deki mevcut metot
            return _repo.GetRandomEnemy(zoneId); // Repository'deki mevcut metot
        }

        // --- YENİ MANTIK ---

        // UI soruyor: "Bu zorluk açık mı?"
        public bool CanEnterDifficulty(int charId, int zoneId, ZoneDifficulty diff)
        {
            if (diff == ZoneDifficulty.Easy) return true; // Easy hep açık

            var data = _repo.GetZoneProgressData(charId, zoneId);

            if (diff == ZoneDifficulty.Normal)
            {
                // Normal unlock: Easy boss must be killed (or legacy markers)
                return _repo.GetBossKilled(charId, zoneId, ZoneDifficulty.Easy)
                    || data.ProgressEasy >=100
                    || data.ProgressEasy ==99;
            }
            if (diff == ZoneDifficulty.Hard)
            {
                return _repo.GetBossKilled(charId, zoneId, ZoneDifficulty.Normal)
                    || data.ProgressNormal >=100
                    || data.ProgressNormal ==99;
            }

            return false;
        }

        // UI soruyor: "Progress Bar kaçta?"
        public int GetProgressValue(int charId, int zoneId, ZoneDifficulty diff)
        {
            var data = _repo.GetZoneProgressData(charId, zoneId);
            int val = diff switch
            {
                ZoneDifficulty.Easy => data.ProgressEasy,
                ZoneDifficulty.Normal => data.ProgressNormal,
                ZoneDifficulty.Hard => data.ProgressHard,
                _ =>0
            };

            // If boss has been killed in this difficulty, consider it completed (show as100)
            if (_repo.GetBossKilled(charId, zoneId, diff)) return100;

            return val;
        }

        // True when this difficulty is fully completed (boss killed). This is the real "100%".
        public bool IsDifficultyCompleted(int charId, int zoneId, ZoneDifficulty diff)
        {
            return _repo.GetBossKilled(charId, zoneId, diff);
        }

        // İlerleme Ekleme
        public void AddProgress(int charId, int zoneId, ZoneDifficulty diff, int amount)
        {
            // After boss killed, we allow infinite replay but progress should stay completed.
            if (IsDifficultyCompleted(charId, zoneId, diff))
            {
                _repo.SaveZoneProgress(charId, zoneId, diff,100);
                return;
            }

            // While not completed: cap at100.
            int current = _repo.GetZoneProgressData(charId, zoneId) switch
            {
                var d when diff == ZoneDifficulty.Easy => d.ProgressEasy,
                var d when diff == ZoneDifficulty.Normal => d.ProgressNormal,
                var d when diff == ZoneDifficulty.Hard => d.ProgressHard,
                _ =>0
            };

            if (current >=100) return;
            _repo.SaveZoneProgress(charId, zoneId, diff, current + amount);
        }

        // İlerleme Sıfırlama (Ölüm durumunda)
        public void ResetProgress(int charId, int zoneId, ZoneDifficulty diff)
        {
            // Completed (boss killed) stages are not reset.
            if (IsDifficultyCompleted(charId, zoneId, diff))
            {
                _repo.SaveZoneProgress(charId, zoneId, diff,100);
                return;
            }

            _repo.SaveZoneProgress(charId, zoneId, diff,0);
        }

        // Progress'i belirli bir değere ayarlama
        public void SetProgress(int charId, int zoneId, ZoneDifficulty diff, int value)
        {
            if (value <0) value =0;
            if (value >100) value =100;

            // Don't allow setting less than100 for completed difficulties.
            if (IsDifficultyCompleted(charId, zoneId, diff)) value =100;

            _repo.SaveZoneProgress(charId, zoneId, diff, value);
        }

        // Query whether the boss for this character/zone/difficulty has been killed
        public bool IsBossKilled(int charId, int zoneId, ZoneDifficulty diff)
        {
            return _repo.GetBossKilled(charId, zoneId, diff);
        }

        // Mark boss as killed in persistent storage
        public void MarkBossKilled(int charId, int zoneId, ZoneDifficulty diff)
        {
            _repo.SetBossKilled(charId, zoneId, diff, true);
            // Keep progress consistent for UI
            _repo.SaveZoneProgress(charId, zoneId, diff,100);
        }
    }
}
