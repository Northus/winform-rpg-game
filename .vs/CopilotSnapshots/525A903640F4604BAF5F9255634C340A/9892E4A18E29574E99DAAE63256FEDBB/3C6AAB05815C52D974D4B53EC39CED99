using rpg_deneme.Core;
using rpg_deneme.Data;
using rpg_deneme.Models;
using System;
using System.Collections.Generic;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using static rpg_deneme.Core.Enums;

namespace rpg_deneme.Business
{
    public class ZoneManager
    {
        private ZoneRepository _repo = new ZoneRepository();
        private CharacterRepository _charRepo = new CharacterRepository();

        public List<ZoneModel> GetAvailableZones(CharacterModel hero)
        {
            if (hero.MaxUnlockedZoneID < 1) hero.MaxUnlockedZoneID = 1;
            var zones = _repo.GetZones(); // Repository'deki mevcut metot
            foreach (var z in zones) z.IsUnlocked = (z.ZoneID <= hero.MaxUnlockedZoneID);
            return zones;
        }

        public EnemyModel GetEnemyForZone(int zoneId, bool spawnBoss)
        {
            if (spawnBoss) return _repo.GetBossForZone(zoneId); // Repository'deki mevcut metot
            return _repo.GetRandomEnemy(zoneId); // Repository'deki mevcut metot
        }

        // --- YENİ MANTIK ---

        // UI soruyor: "Bu zorluk açık mı?"
        public bool CanEnterDifficulty(int charId, int zoneId, ZoneDifficulty diff)
        {
            if (diff == ZoneDifficulty.Easy) return true; // Easy hep açık

            var data = _repo.GetZoneProgressData(charId, zoneId);

            if (diff == ZoneDifficulty.Normal)
            {
                // Treat legacy value99 (boss killed) as completed; require >=100 (or99 as boss-killed) for unlock
                return data.ProgressEasy >=100 || data.ProgressEasy ==99 || _repo.GetBossKilled(charId, zoneId, ZoneDifficulty.Easy);
            }
            if (diff == ZoneDifficulty.Hard)
            {
                return data.ProgressNormal >=100 || data.ProgressNormal ==99 || _repo.GetBossKilled(charId, zoneId, ZoneDifficulty.Normal);
            }

            return false;
        }

        // UI soruyor: "Progress Bar kaçta?"
        public int GetProgressValue(int charId, int zoneId, ZoneDifficulty diff)
        {
            var data = _repo.GetZoneProgressData(charId, zoneId);
            switch (diff)
            {
                case ZoneDifficulty.Easy: return data.ProgressEasy;
                case ZoneDifficulty.Normal: return data.ProgressNormal;
                case ZoneDifficulty.Hard: return data.ProgressHard;
                default: return 0;
            }
        }

        // İlerleme Ekleme
        public void AddProgress(int charId, int zoneId, ZoneDifficulty diff, int amount)
        {
            int current = GetProgressValue(charId, zoneId, diff);
            if (current >= 100) return; // Zaten bitmiş

            _repo.SaveZoneProgress(charId, zoneId, diff, current + amount);
        }

        // İlerleme Sıfırlama (Ölüm durumunda)
        public void ResetProgress(int charId, int zoneId, ZoneDifficulty diff)
        {
            _repo.SaveZoneProgress(charId, zoneId, diff, 0);
        }

        // Progress'i belirli bir değere ayarlama (Boss yendikten sonra 99'a düşürmek için)
        public void SetProgress(int charId, int zoneId, ZoneDifficulty diff, int value)
        {
            if (value <0) value =0;
            if (value >100) value =100;
            _repo.SaveZoneProgress(charId, zoneId, diff, value);
        }
        
        // Query whether the boss for this character/zone/difficulty has been killed
        public bool IsBossKilled(int charId, int zoneId, ZoneDifficulty diff)
        {
            return _repo.GetBossKilled(charId, zoneId, diff);
        }

        // Mark boss as killed in persistent storage
        public void MarkBossKilled(int charId, int zoneId, ZoneDifficulty diff)
        {
            _repo.SetBossKilled(charId, zoneId, diff, true);
        }
    }
}
