using Microsoft.Data.SqlClient;
using rpg_deneme.Core;
using rpg_deneme.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using static rpg_deneme.Core.Enums;

namespace rpg_deneme.Data
{
    // Veritabanından dönecek basit veri taşıyıcı
    public class ZoneProgressDTO
    {
        public int ProgressEasy { get; set; }
        public int ProgressNormal { get; set; }
        public int ProgressHard { get; set; }
        // New flags persisted in CharacterZoneData when DB schema updated
        public bool BossKilledEasy { get; set; }
        public bool BossKilledNormal { get; set; }
        public bool BossKilledHard { get; set; }
    }

    public class ZoneRepository
    {
        // Get all zones from DB
        public List<ZoneModel> GetZones()
        {
            var list = new List<ZoneModel>();
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                string sql = "SELECT ZoneID, Name, Description, MinLevel, OrderIndex FROM Zones ORDER BY OrderIndex";
                using (var cmd = new SqlCommand(sql, conn))
                using (var dr = cmd.ExecuteReader())
                {
                    while (dr.Read())
                    {
                        list.Add(new ZoneModel
                        {
                            ZoneID = (int)dr["ZoneID"],
                            Name = dr["Name"]?.ToString(),
                            Description = dr["Description"]?.ToString(),
                            MinLevel = dr["MinLevel"] != DBNull.Value ? (int)dr["MinLevel"] :1,
                            OrderIndex = dr["OrderIndex"] != DBNull.Value ? (int)dr["OrderIndex"] :0
                        });
                    }
                }
            }
            return list;
        }

        // Choose a random enemy template for a zone (non-boss) using ZoneEnemies spawn rates
        public EnemyModel GetRandomEnemy(int zoneId)
        {
            var candidates = new List<(int EnemyID, int SpawnRate)>();
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                string sql = @"
                 SELECT Z.EnemyID, Z.SpawnRate
                 FROM ZoneEnemies Z
                 INNER JOIN Enemies E ON Z.EnemyID = E.EnemyID
                 WHERE Z.ZoneID = @zid AND (E.IsBoss =0 OR E.IsBoss IS NULL)";
                using (var cmd = new SqlCommand(sql, conn))
                {
                    cmd.Parameters.AddWithValue("@zid", zoneId);
                    using (var dr = cmd.ExecuteReader())
                    {
                        while (dr.Read())
                        {
                            candidates.Add(((int)dr["EnemyID"], dr["SpawnRate"] != DBNull.Value ? (int)dr["SpawnRate"] :1));
                        }
                    }
                }
            }

            if (candidates.Count ==0)
            {
                // fallback: any non-boss enemy
                return GetAnyNonBossEnemy();
            }

            // weighted random
            int total = candidates.Sum(c => c.SpawnRate);
            var rnd = new Random();
            int pick = rnd.Next(0, Math.Max(1, total));
            int acc =0;
            int chosenId = candidates[0].EnemyID;
            foreach (var c in candidates)
            {
                acc += c.SpawnRate;
                if (pick < acc)
                {
                    chosenId = c.EnemyID;
                    break;
                }
            }

            return LoadEnemyById(chosenId);
        }

        // Get boss for zone (first boss enemy associated with zone)
        public EnemyModel GetBossForZone(int zoneId)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                // SQL Düzeltildi: Takma adları (alias) ve JOIN yapısını sadeleştirdik.
                // Ayrıca SpawnRate'e göre sıralama mantığını ekledik.
                string sql = @"
                SELECT TOP 1 e.* FROM Enemies e
                INNER JOIN ZoneEnemies ze ON e.EnemyID = ze.EnemyID
                WHERE ze.ZoneID = @zid AND e.IsBoss = 1
                ORDER BY ze.SpawnRate DESC";

                using (var cmd = new Microsoft.Data.SqlClient.SqlCommand(sql, conn))
                {
                    cmd.Parameters.AddWithValue("@zid", zoneId);

                    using (var dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            // Okuma işlemleri (LoadEnemyById kullanmadan direkt model oluşturuyoruz)
                            string path = dr["SpritePath"] != DBNull.Value ? dr["SpritePath"].ToString().Trim() : "";
                            var type = Core.Enums.EnemyType.Boss;
                            if (path.ToUpper().Contains("RANGED")) type = Core.Enums.EnemyType.Ranged;

                            return new EnemyModel
                            {
                                EnemyID = (int)dr["EnemyID"],
                                Name = dr["Name"].ToString(),
                                Level = dr["Level"] != DBNull.Value ? (int)dr["Level"] : 1,
                                MaxHP = dr["MaxHP"] != DBNull.Value ? (int)dr["MaxHP"] : 100,
                                CurrentHP = dr["MaxHP"] != DBNull.Value ? (int)dr["MaxHP"] : 100,
                                Damage = dr["Damage"] != DBNull.Value ? (int)dr["Damage"] : 10,
                                ExpReward = dr["ExpReward"] != DBNull.Value ? (int)dr["ExpReward"] : 0,
                                GoldReward = dr["GoldReward"] != DBNull.Value ? (int)dr["GoldReward"] : 0,
                                IsBoss = true,
                                Type = type,
                                SpritePath = path,
                                Speed = 3.5f,
                                Width = 60,
                                Height = 60
                            };
                        }
                    }
                }
            }
            return null; // Boss bulunamadı
        }

        // Returns list of enemies within level range (non-boss)
        public List<EnemyModel> GetEnemiesByLevelRange(int minLvl, int maxLvl)
        {
            var list = new List<EnemyModel>();
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                string sql = @"SELECT EnemyID FROM Enemies WHERE Level BETWEEN @min AND @max AND (IsBoss =0 OR IsBoss IS NULL)";
                using (var cmd = new SqlCommand(sql, conn))
                {
                    cmd.Parameters.AddWithValue("@min", minLvl);
                    cmd.Parameters.AddWithValue("@max", maxLvl);
                    using (var dr = cmd.ExecuteReader())
                    {
                        while (dr.Read())
                        {
                            list.Add(LoadEnemyById((int)dr["EnemyID"]));
                        }
                    }
                }
            }
            return list;
        }

        // Helper: load full enemy data from Enemies table
        private EnemyModel LoadEnemyById(int enemyId)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                string sql = @"SELECT EnemyID, Name, Level, MaxHP, Damage, ExpReward, GoldReward, SpritePath, IsBoss FROM Enemies WHERE EnemyID = @eid";
                using (var cmd = new SqlCommand(sql, conn))
                {
                    cmd.Parameters.AddWithValue("@eid", enemyId);
                    using (var dr = cmd.ExecuteReader())
                    {
                        if (dr.Read())
                        {
                            var em = new EnemyModel();
                            em.EnemyID = (int)dr["EnemyID"];
                            em.Name = dr["Name"]?.ToString();
                            em.Level = dr["Level"] != DBNull.Value ? (int)dr["Level"] :1;
                            em.MaxHP = dr["MaxHP"] != DBNull.Value ? (int)dr["MaxHP"] :50;
                            em.CurrentHP = em.MaxHP;
                            em.Damage = dr["Damage"] != DBNull.Value ? (int)dr["Damage"] :5;
                            em.ExpReward = dr["ExpReward"] != DBNull.Value ? (int)dr["ExpReward"] :0;
                            em.GoldReward = dr["GoldReward"] != DBNull.Value ? (int)dr["GoldReward"] :0;
                            em.SpritePath = dr["SpritePath"]?.ToString();
                            em.IsBoss = dr["IsBoss"] != DBNull.Value && (bool)dr["IsBoss"];

                            // DB doesn't store Type/IsRanged/Speed/Size/AttackRange; assign sensible defaults
                            em.Type = em.IsBoss ? EnemyType.Boss : EnemyType.Melee;
                            em.Speed =1.0f;
                            em.Width =32;
                            em.Height =32;
                            em.IsRanged = false;
                            em.AttackRange =50;

                            // Heuristic: if name contains 'arch' or 'bow' treat as ranged
                            if (!string.IsNullOrEmpty(em.Name))
                            {
                                string lower = em.Name.ToLowerInvariant();
                                if (lower.Contains("arch") || lower.Contains("bow") || lower.Contains("ranged") || lower.Contains("shooter"))
                                {
                                    em.Type = EnemyType.Ranged;
                                    em.IsRanged = true;
                                    em.AttackRange =220;
                                }
                            }

                            return em;
                        }
                    }
                }
            }
            return null;
        }

        private EnemyModel GetAnyNonBossEnemy()
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                string sql = "SELECT TOP1 EnemyID FROM Enemies WHERE IsBoss =0 OR IsBoss IS NULL";
                using (var cmd = new SqlCommand(sql, conn))
                {
                    var obj = cmd.ExecuteScalar();
                    if (obj != null && obj != DBNull.Value)
                    {
                        return LoadEnemyById(Convert.ToInt32(obj));
                    }
                }
            }
            return null;
        }

        private EnemyModel GetAnyBossEnemy()
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                string sql = "SELECT TOP1 EnemyID FROM Enemies WHERE IsBoss =1";
                using (var cmd = new SqlCommand(sql, conn))
                {
                    var obj = cmd.ExecuteScalar();
                    if (obj != null && obj != DBNull.Value)
                    {
                        return LoadEnemyById(Convert.ToInt32(obj));
                    }
                }
            }
            return null;
        }

        public ZoneProgressDTO GetZoneProgressData(int charId, int zoneId)
        {
            var result = new ZoneProgressDTO();
            try
            {
                using (var conn = DatabaseHelper.GetConnection())
                {
                    conn.Open();
                    // Read progress and boss-killed flags (if DB columns exist)
                    string sql = @"SELECT ProgressEasy, ProgressNormal, ProgressHard,
+ ISNULL(BossKilledEasy,0) AS BossKilledEasy,
+ ISNULL(BossKilledNormal,0) AS BossKilledNormal,
+ ISNULL(BossKilledHard,0) AS BossKilledHard
+ FROM CharacterZoneData WHERE CharacterID=@cid AND ZoneID=@zid";
                    using (var cmd = new SqlCommand(sql, conn))
                    {
                        cmd.Parameters.AddWithValue("@cid", charId);
                        cmd.Parameters.AddWithValue("@zid", zoneId);
                        using (var dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                result.ProgressEasy = dr["ProgressEasy"] != DBNull.Value ? (int)dr["ProgressEasy"] :0;
                                result.ProgressNormal = dr["ProgressNormal"] != DBNull.Value ? (int)dr["ProgressNormal"] :0;
                                result.ProgressHard = dr["ProgressHard"] != DBNull.Value ? (int)dr["ProgressHard"] :0;
                                result.BossKilledEasy = dr["BossKilledEasy"] != DBNull.Value && ((int)dr["BossKilledEasy"]) !=0;
                                result.BossKilledNormal = dr["BossKilledNormal"] != DBNull.Value && ((int)dr["BossKilledNormal"]) !=0;
                                result.BossKilledHard = dr["BossKilledHard"] != DBNull.Value && ((int)dr["BossKilledHard"]) !=0;
                            }
                        }
                    }
                }
            }
            catch
            {
                // If the new columns don't exist or any error occurs, fall back to legacy behaviour
                using (var conn = DatabaseHelper.GetConnection())
                {
                    conn.Open();
                    string sql = "SELECT ProgressEasy, ProgressNormal, ProgressHard FROM CharacterZoneData WHERE CharacterID=@cid AND ZoneID=@zid";
                    using (var cmd = new SqlCommand(sql, conn))
                    {
                        cmd.Parameters.AddWithValue("@cid", charId);
                        cmd.Parameters.AddWithValue("@zid", zoneId);
                        using (var dr = cmd.ExecuteReader())
                        {
                            if (dr.Read())
                            {
                                result.ProgressEasy = dr["ProgressEasy"] != DBNull.Value ? (int)dr["ProgressEasy"] :0;
                                result.ProgressNormal = dr["ProgressNormal"] != DBNull.Value ? (int)dr["ProgressNormal"] :0;
                                result.ProgressHard = dr["ProgressHard"] != DBNull.Value ? (int)dr["ProgressHard"] :0;
                            }
                        }
                    }
                }
                // BossKilled flags remain false in fallback; legacy code may use99 marker
            }

            return result;
        }

        public void SaveZoneProgress(int charId, int zoneId, ZoneDifficulty diff, int newVal)
        {
            if (newVal >100) newVal =100;

            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                // Kayıt var mı?
                string checkSql = "SELECT COUNT(*) FROM CharacterZoneData WHERE CharacterID=@cid AND ZoneID=@zid";
                var cmdCheck = new SqlCommand(checkSql, conn);
                cmdCheck.Parameters.AddWithValue("@cid", charId);
                cmdCheck.Parameters.AddWithValue("@zid", zoneId);
                int count = (int)cmdCheck.ExecuteScalar();

                string colName = "ProgressEasy";
                if (diff == ZoneDifficulty.Normal) colName = "ProgressNormal";
                if (diff == ZoneDifficulty.Hard) colName = "ProgressHard";

                if (count ==0)
                {
                    string insertSql = $"INSERT INTO CharacterZoneData (CharacterID, ZoneID, {colName}) VALUES (@cid, @zid, @val)";
                    var cmd = new SqlCommand(insertSql, conn);
                    cmd.Parameters.AddWithValue("@cid", charId);
                    cmd.Parameters.AddWithValue("@zid", zoneId);
                    cmd.Parameters.AddWithValue("@val", newVal);
                    cmd.ExecuteNonQuery();
                }
                else
                {
                    string updateSql = $"UPDATE CharacterZoneData SET {colName}=@val WHERE CharacterID=@cid AND ZoneID=@zid";
                    var cmd = new SqlCommand(updateSql, conn);
                    cmd.Parameters.AddWithValue("@cid", charId);
                    cmd.Parameters.AddWithValue("@zid", zoneId);
                    cmd.Parameters.AddWithValue("@val", newVal);
                    cmd.ExecuteNonQuery();
                }
            }
        }
        
        // Persist whether boss was defeated for a character/zone/difficulty
        // Check boss-killed flag stored on CharacterZoneData (new schema) or fall back to legacy99 progress marker
        public bool GetBossKilled(int charId, int zoneId, ZoneDifficulty diff)
        {
            try
            {
                var dto = GetZoneProgressData(charId, zoneId);
                return diff == ZoneDifficulty.Easy ? dto.BossKilledEasy : diff == ZoneDifficulty.Normal ? dto.BossKilledNormal : dto.BossKilledHard;
            }
            catch
            {
                var dto = GetZoneProgressData(charId, zoneId);
                int val = diff == ZoneDifficulty.Easy ? dto.ProgressEasy : diff == ZoneDifficulty.Normal ? dto.ProgressNormal : dto.ProgressHard;
                return val ==99; // legacy fallback
            }
        }

        // Persist boss-killed flag on CharacterZoneData table (requires adding BossKilledEasy/Normal/Hard columns)
        public void SetBossKilled(int charId, int zoneId, ZoneDifficulty diff, bool killed)
        {
            try
            {
                using (var conn = DatabaseHelper.GetConnection())
                {
                    conn.Open();

                    string colName = diff == ZoneDifficulty.Easy ? "BossKilledEasy" : diff == ZoneDifficulty.Normal ? "BossKilledNormal" : "BossKilledHard";

                    // Ensure the BossKilled column exists in the table; if not, add it (safe to run repeatedly)
                    string ensureColSql = $@"IF COL_LENGTH('dbo.CharacterZoneData','{colName}') IS NULL
+BEGIN
+ ALTER TABLE dbo.CharacterZoneData ADD {colName} BIT NOT NULL CONSTRAINT DF_CharacterZoneData_{colName} DEFAULT(0);
+END";
                    using (var cmdEnsure = new SqlCommand(ensureColSql, conn)) cmdEnsure.ExecuteNonQuery();

                    // Ensure row exists
                    string checkSql = "SELECT COUNT(*) FROM CharacterZoneData WHERE CharacterID=@cid AND ZoneID=@zid";
                    using (var cmdCheck = new SqlCommand(checkSql, conn))
                    {
                        cmdCheck.Parameters.AddWithValue("@cid", charId);
                        cmdCheck.Parameters.AddWithValue("@zid", zoneId);
                        int count = (int)cmdCheck.ExecuteScalar();
                        if (count ==0)
                        {
                            // insert default row with the boss flag
                            string insertSql = $"INSERT INTO CharacterZoneData (CharacterID, ZoneID, {colName}) VALUES (@cid, @zid, @val)";
                            using (var cmd = new SqlCommand(insertSql, conn))
                            {
                                cmd.Parameters.AddWithValue("@cid", charId);
                                cmd.Parameters.AddWithValue("@zid", zoneId);
                                cmd.Parameters.AddWithValue("@val", killed ?1 :0);
                                cmd.ExecuteNonQuery();
                            }
                        }
                        else
                        {
                            string updateSql = $"UPDATE CharacterZoneData SET {colName}=@val WHERE CharacterID=@cid AND ZoneID=@zid";
                            using (var cmd = new SqlCommand(updateSql, conn))
                            {
                                cmd.Parameters.AddWithValue("@cid", charId);
                                cmd.Parameters.AddWithValue("@zid", zoneId);
                                cmd.Parameters.AddWithValue("@val", killed ?1 :0);
                                cmd.ExecuteNonQuery();
                            }
                        }
                    }
                }
            }
            catch
            {
                // fallback: legacy approach set progress to99 when killed
                if (killed)
                {
                    SaveZoneProgress(charId, zoneId, diff,99);
                }
            }
        }
    }
}