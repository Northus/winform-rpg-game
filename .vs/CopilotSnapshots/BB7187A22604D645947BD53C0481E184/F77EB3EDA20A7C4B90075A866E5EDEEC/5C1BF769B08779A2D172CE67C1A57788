using System;
using System.Collections.Generic;
using Microsoft.Data.Sqlite;
using rpg_deneme.Models;
using static rpg_deneme.Core.Enums;

namespace rpg_deneme.Data
{
    public class CharacterRepository
    {
        /// <summary>
        /// Belirli bir kullanıcıya ait tüm karakterleri listeler.
        /// </summary>
        public List<CharacterModel> GetCharacters()
        {
            var list = new List<CharacterModel>();
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                using var cmd = new SQLiteCommand("SELECT * FROM Characters", conn);

                using (var dr = cmd.ExecuteReader())
                {
                    while (dr.Read())
                    {
                        list.Add(new CharacterModel
                        {
                            CharacterID = Convert.ToInt32(dr["CharacterID"]),
                            Name = dr["Name"]?.ToString(),
                            Class = Convert.ToByte(dr["Class"]),
                            Level = dr["Level"] != DBNull.Value ? Convert.ToInt32(dr["Level"]) : 1,
                            Experience = dr["Experience"] != DBNull.Value ? Convert.ToInt64(dr["Experience"]) : 0,
                            STR = dr["STR"] != DBNull.Value ? Convert.ToInt32(dr["STR"]) : 0,
                            DEX = dr["DEX"] != DBNull.Value ? Convert.ToInt32(dr["DEX"]) : 0,
                            INT = dr["INT"] != DBNull.Value ? Convert.ToInt32(dr["INT"]) : 0,
                            VIT = dr["VIT"] != DBNull.Value ? Convert.ToInt32(dr["VIT"]) : 0,
                            StatPoints = dr["StatPoints"] != DBNull.Value ? Convert.ToInt32(dr["StatPoints"]) : 0,
                            HP = dr["CurrentHP"] != DBNull.Value ? Convert.ToInt32(dr["CurrentHP"]) : 100,
                            Mana = dr["CurrentMana"] != DBNull.Value ? Convert.ToInt32(dr["CurrentMana"]) : 50,
                            Gold = dr["Gold"] != DBNull.Value ? Convert.ToInt64(dr["Gold"]) : 0,
                            MaxSurvivalWave = dr["MaxSurvivalWave"] != DBNull.Value ? Convert.ToInt32(dr["MaxSurvivalWave"]) : 1,
                            CurrentZoneID = dr["CurrentZoneID"] != DBNull.Value ? Convert.ToInt32(dr["CurrentZoneID"]) : 1,
                            MaxUnlockedZoneID = dr["MaxUnlockedZoneID"] != DBNull.Value ? Convert.ToInt32(dr["MaxUnlockedZoneID"]) : 1
                        });
                    }
                }
            }
            return list;
        }

        /// <summary>
        /// Yeni bir karakter oluşturur.
        /// </summary>
        public bool CreateCharacter(CharacterModel hero)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();

                // Başlangıç Statları (Eğer formdan 0 geldiyse varsayılan ata)
                int str = hero.STR > 0 ? hero.STR : 5;
                int dex = hero.DEX > 0 ? hero.DEX : 5;
                int intel = hero.INT > 0 ? hero.INT : 5;
                int vit = hero.VIT > 0 ? hero.VIT : 10;
                int startHP = 100;
                int startMana = 50;

                string sql = @"
                INSERT INTO Characters 
                (
                    Name, Class, Level, Experience, 
                    STR, DEX, INT, VIT, StatPoints, 
                    CurrentHP, CurrentMana, 
                    MaxUnlockedZoneID, CurrentZoneID, MaxSurvivalWave
                ) 
                VALUES 
                (
                    @name, @class, 1, 0, 
                    @str, @dex, @int, @vit, 0,
                    @hp, @mana,   
                    1, 1, 1
                )";

                using var cmd = new SQLiteCommand(sql, conn);
                cmd.Parameters.AddWithValue("@name", (object)hero.Name ?? "Adsız Kahraman");
                cmd.Parameters.AddWithValue("@class", hero.Class);
                cmd.Parameters.AddWithValue("@str", str);
                cmd.Parameters.AddWithValue("@dex", dex);
                cmd.Parameters.AddWithValue("@int", intel);
                cmd.Parameters.AddWithValue("@vit", vit);
                cmd.Parameters.AddWithValue("@hp", startHP);
                cmd.Parameters.AddWithValue("@mana", startMana);

                return cmd.ExecuteNonQuery() > 0;
            }
        }

        /// <summary>
        /// Verilen ismin veritabanında daha önce alınıp alınmadığını kontrol eder.
        /// </summary>
        public bool IsNameAvailable(string name)
        {
            using (SQLiteConnection conn = DatabaseHelper.GetConnection())
            {
                string sql = "SELECT COUNT(*) FROM Characters WHERE Name = @name";
                using var cmd = new SQLiteCommand(sql, conn);
                cmd.Parameters.AddWithValue("@name", name);

                conn.Open();
                long count = (long)cmd.ExecuteScalar();
                return count == 0;
            }
        }

        /// <summary>
        /// Karakteri siler.
        /// </summary>
        public bool DeleteCharacter(int characterId)
        {
            using (SQLiteConnection conn = DatabaseHelper.GetConnection())
            {
                string sql = "DELETE FROM Characters WHERE CharacterID = @id";
                using var cmd = new SQLiteCommand(sql, conn);
                cmd.Parameters.AddWithValue("@id", characterId);

                conn.Open();
                return cmd.ExecuteNonQuery() > 0;
            }
        }

        // Karakterin temel statlarını ve kalan puanını günceller
        public bool UpdateStats(CharacterModel hero)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                string sql = @"
            UPDATE Characters 
            SET STR = @str, DEX = @dex, INT = @int, VIT = @vit, StatPoints = @pts 
            WHERE CharacterID = @id";

                using var cmd = new SQLiteCommand(sql, conn);
                cmd.Parameters.AddWithValue("@str", hero.STR);
                cmd.Parameters.AddWithValue("@dex", hero.DEX);
                cmd.Parameters.AddWithValue("@int", hero.INT);
                cmd.Parameters.AddWithValue("@vit", hero.VIT);
                cmd.Parameters.AddWithValue("@pts", hero.StatPoints);
                cmd.Parameters.AddWithValue("@id", hero.CharacterID);

                conn.Open();
                return cmd.ExecuteNonQuery() > 0;
            }
        }

        // Karakterin ilerleme durumunu (Level, XP, HP, Mana, MaxUnlockedZone ve CurrentZone) kaydeder
        public bool UpdateProgress(CharacterModel hero)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                string sql = @"
                UPDATE Characters 
                SET Level = @lvl, 
                    Experience = @exp, 
                    StatPoints = @statPts,
                    CurrentHP = @hp, 
                    CurrentMana = @mana, 
                    MaxSurvivalWave = @maxWave,
                    MaxUnlockedZoneID = @maxZone,
                    CurrentZoneID = @currentZone
                WHERE CharacterID = @id";

                using var cmd = new SQLiteCommand(sql, conn);
                cmd.Parameters.AddWithValue("@lvl", hero.Level);
                cmd.Parameters.AddWithValue("@exp", hero.Experience);
                cmd.Parameters.AddWithValue("@statPts", hero.StatPoints);
                cmd.Parameters.AddWithValue("@hp", hero.HP);
                cmd.Parameters.AddWithValue("@mana", hero.Mana);
                cmd.Parameters.AddWithValue("@id", hero.CharacterID);
                cmd.Parameters.AddWithValue("@maxWave", hero.MaxSurvivalWave);
                cmd.Parameters.AddWithValue("@maxZone", hero.MaxUnlockedZoneID);
                cmd.Parameters.AddWithValue("@currentZone", hero.CurrentZoneID);

                conn.Open();
                return cmd.ExecuteNonQuery() > 0;
            }
        }

        public void UpdateCharacterStats(CharacterModel hero)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                string sql = @"
                UPDATE Characters 
                SET 
                    Level = @lvl,
                    Experience = @xp,
                    StatPoints = @sp,
                    CurrentHP = @hp,
                    CurrentMana = @mana
                WHERE CharacterID = @id";

                using var cmd = new SQLiteCommand(sql, conn);
                cmd.Parameters.AddWithValue("@lvl", hero.Level);
                cmd.Parameters.AddWithValue("@xp", hero.Experience);
                cmd.Parameters.AddWithValue("@sp", hero.StatPoints);
                cmd.Parameters.AddWithValue("@hp", hero.HP);
                cmd.Parameters.AddWithValue("@mana", hero.Mana);
                cmd.Parameters.AddWithValue("@id", hero.CharacterID);

                cmd.ExecuteNonQuery();
            }
        }

        public void UpdateMaxSurvivalWave(int characterId, int newMaxWave)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                string sql = "UPDATE Characters SET MaxSurvivalWave = @wave WHERE CharacterID = @id";

                using (var cmd = new SQLiteCommand(sql, conn))
                {
                    cmd.Parameters.AddWithValue("@wave", newMaxWave);
                    cmd.Parameters.AddWithValue("@id", characterId);

                    conn.Open();
                    cmd.ExecuteNonQuery();
                }
            }
        }
    }
}

