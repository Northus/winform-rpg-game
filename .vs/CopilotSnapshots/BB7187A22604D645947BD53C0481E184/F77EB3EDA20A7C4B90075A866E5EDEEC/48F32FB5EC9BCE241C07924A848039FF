using System;
using System.Collections.Generic;
using Microsoft.Data.Sqlite;
using rpg_deneme.Models;

namespace rpg_deneme.Data
{
    public class LootRepository
    {
        // Loot tablosunu çekerken artık ItemTemplates ile birleştirip
        // o eşyanın tipini, stacklenebilir olup olmadığını da öğreniyoruz.
        public List<LootTableModel> GetLootTableForEnemy(int enemyId)
        {
            var list = new List<LootTableModel>();
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                string sql = @"
                    SELECT L.LootID, L.EnemyID, L.TemplateID, L.DropRate, L.MinLevel,
                           T.ItemType, T.IsStackable, T.MaxStack
                    FROM LootTables L
                    INNER JOIN ItemTemplates T ON L.TemplateID = T.TemplateID
                    WHERE L.EnemyID = @eid";

                using var cmd = new SqliteCommand(sql, conn);
                cmd.Parameters.AddWithValue("@eid", enemyId);

                using (var dr = cmd.ExecuteReader())
                {
                    while (dr.Read())
                    {
                        list.Add(new LootTableModel
                        {
                            LootID = Convert.ToInt32(dr["LootID"]),
                            EnemyID = Convert.ToInt32(dr["EnemyID"]),
                            TemplateID = Convert.ToInt32(dr["TemplateID"]),
                            DropRate = Convert.ToDouble(dr["DropRate"]),
                            ItemType = (Core.Enums.ItemType)Convert.ToByte(dr["ItemType"]),
                            IsStackable = dr["IsStackable"] != DBNull.Value && Convert.ToBoolean(dr["IsStackable"]),
                            MaxStack = dr["MaxStack"] != DBNull.Value ? Convert.ToInt32(dr["MaxStack"]) : 1
                        });
                    }
                }
            }
            return list;
        }
    }
}
