using Microsoft.Data.SqlClient;
using rpg_deneme.Models;
using System;
using System.Collections.Generic;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using static rpg_deneme.Core.Enums;

namespace rpg_deneme.Data
{
    public class ZoneRepository
    {
        // Tüm Zoneları çeker
        public List<ZoneModel> GetZones()
        {
            var list = new List<ZoneModel>();
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                SqlCommand cmd = new SqlCommand("SELECT * FROM Zones ORDER BY OrderIndex", conn);
                using (var dr = cmd.ExecuteReader())
                {
                    while (dr.Read())
                    {
                        list.Add(new ZoneModel
                        {
                            ZoneID = (int)dr["ZoneID"],
                            Name = dr["Name"].ToString(),
                            Description = dr["Description"].ToString(),
                            MinLevel = (int)dr["MinLevel"],
                            OrderIndex = (int)dr["OrderIndex"]
                        });
                    }
                }
            }
            return list;
        }

        // Belirli bir Zone'daki rastgele düşmanı çeker
        public EnemyModel GetRandomEnemy(int zoneId)
        {
            // Basitçe o zone'a ait rastgele bir düşman çekelim (SpawnRate ağırlıklı yapılabilir ama şimdilik düz yapıyoruz)
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                string sql = @"
                    SELECT TOP 1 e.* FROM Enemies e
                    JOIN ZoneEnemies ze ON e.EnemyID = ze.EnemyID
                    WHERE ze.ZoneID = @zid AND e.IsBoss = 0
                    ORDER BY NEWID()"; // SQL Server'da rastgele sıralama

                SqlCommand cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@zid", zoneId);

                using (var dr = cmd.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        string path = dr["SpritePath"] != DBNull.Value ? dr["SpritePath"].ToString().Trim() : string.Empty;
                        string pathUp = path.ToUpper();
                        EnemyType type = EnemyType.Melee;
                        if (pathUp.Contains("RANGED") || (dr["Type"] != DBNull.Value && dr["Type"].ToString().ToUpper().Contains("RANGED"))) type = EnemyType.Ranged;

                        return new EnemyModel
                        {
                            EnemyID = (int)dr["EnemyID"],
                            Name = dr["Name"].ToString(),
                            Level = (int)dr["Level"],
                            MaxHP = (int)dr["MaxHP"],
                            CurrentHP = (int)dr["MaxHP"],
                            Damage = (int)dr["Damage"],
                            ExpReward = (int)dr["ExpReward"],
                            GoldReward = (int)dr["GoldReward"],
                            Speed = dr["Speed"] != DBNull.Value ? Convert.ToSingle(dr["Speed"]) : 2f, // Varsayılan hız
                            Width = dr["Width"] != DBNull.Value ? Convert.ToInt32(dr["Width"]) : 40,
                            Height = dr["Height"] != DBNull.Value ? Convert.ToInt32(dr["Height"]) : 40,
                            Type = type,
                            SpritePath = path
                        };
                    }
                }
            }
            return null; // Düşman yoksa
        }
        public EnemyModel GetBossForZone(int zoneId)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                string sql = @"
                SELECT TOP 1 e.* FROM Enemies e
                JOIN ZoneEnemies ze ON e.EnemyID = ze.EnemyID
                WHERE ze.ZoneID = @zid AND e.IsBoss = 1"; // Sadece BOSS getir

                SqlCommand cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@zid", zoneId);

                using (var dr = cmd.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        string path = dr["SpritePath"] != DBNull.Value ? dr["SpritePath"].ToString().Trim() : string.Empty;
                        string pathUp = path.ToUpper();
                        EnemyType type = EnemyType.Boss;
                        if (pathUp.Contains("RANGED") || (dr["Type"] != DBNull.Value && dr["Type"].ToString().ToUpper().Contains("RANGED"))) type = EnemyType.Ranged;

                        return new EnemyModel
                        {
                            EnemyID = (int)dr["EnemyID"],
                            Name = dr["Name"].ToString(),
                            Level = (int)dr["Level"],
                            MaxHP = (int)dr["MaxHP"],
                            CurrentHP = (int)dr["MaxHP"],
                            Damage = (int)dr["Damage"],
                            ExpReward = (int)dr["ExpReward"],
                            GoldReward = (int)dr["GoldReward"],
                            Speed = dr["Speed"] != DBNull.Value ? Convert.ToSingle(dr["Speed"]) : 4f, // Varsayılan hız
                            Width = dr["Width"] != DBNull.Value ? Convert.ToInt32(dr["Width"]) : 60,
                            Height = dr["Height"] != DBNull.Value ? Convert.ToInt32(dr["Height"]) : 60,
                            IsBoss = true,
                            Type = type,
                            SpritePath = path
                        };
                    }
                }
            }
            return null; // Boss yoksa
        }
        public List<EnemyModel> GetEnemiesByLevelRange(int minLevel, int maxLevel)
        {
            var enemies = new List<EnemyModel>();
            using (var conn = DatabaseHelper.GetConnection())
            {
                // Level aralığına giren düşmanları çek
                string sql = @"
                SELECT EnemyID, Name, Level, MaxHP, Damage, ExpReward, GoldReward, SpritePath 
                FROM Enemies 
                WHERE Level >= @min AND Level <= @max";

                var cmd = new Microsoft.Data.SqlClient.SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@min", minLevel);
                cmd.Parameters.AddWithValue("@max", maxLevel);

                conn.Open();
                using (var dr = cmd.ExecuteReader())
                {
                    while (dr.Read())
                    {
                        string path = dr["SpritePath"] != DBNull.Value ? dr["SpritePath"].ToString().Trim().ToUpper() : "MELEE";
                        EnemyType type = EnemyType.Melee;
                        if (path.Contains("RANGED")) type = EnemyType.Ranged;
                        enemies.Add(new EnemyModel
                        {
                            EnemyID = (int)dr["EnemyID"],
                            Name = dr["Name"].ToString(),
                            Level = (int)dr["Level"],
                            MaxHP = (int)dr["MaxHP"],
                            CurrentHP = (int)dr["MaxHP"], // Başlangıçta full can
                            Damage = (int)dr["Damage"],
                            ExpReward = (int)dr["ExpReward"],
                            GoldReward = (int)dr["GoldReward"],
                            Type = type,
                            SpritePath = dr["SpritePath"] != DBNull.Value ? dr["SpritePath"].ToString() : string.Empty
                        });
                    }
                }
            }
            return enemies;
        }
        public int GetUnlockedDifficulty(int charId, int zoneId)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                // Kayıt yoksa 0 (Easy) döner
                string sql = "SELECT UnlockedDifficulty FROM CharacterZoneData WHERE CharacterID=@cid AND ZoneID=@zid";
                var cmd = new Microsoft.Data.SqlClient.SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@cid", charId);
                cmd.Parameters.AddWithValue("@zid", zoneId);
                conn.Open();
                var result = cmd.ExecuteScalar();
                return result != null ? (int)result : 0;
            }
        }

        public void UnlockNextDifficulty(int charId, int zoneId, int currentDiff)
        {
            // Bir sonraki zorluğu aç (Max 2)
            int nextDiff = Math.Min(2, currentDiff + 1);

            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                // Önce kayıt var mı bak
                string check = "SELECT Count(*) FROM CharacterZoneData WHERE CharacterID=@cid AND ZoneID=@zid";
                var cmdCheck = new Microsoft.Data.SqlClient.SqlCommand(check, conn);
                cmdCheck.Parameters.AddWithValue("@cid", charId);
                cmdCheck.Parameters.AddWithValue("@zid", zoneId);

                int count = (int)cmdCheck.ExecuteScalar();

                if (count == 0)
                {
                    string ins = "INSERT INTO CharacterZoneData (CharacterID, ZoneID, UnlockedDifficulty) VALUES (@cid, @zid, @nd)";
                    var cmdIns = new Microsoft.Data.SqlClient.SqlCommand(ins, conn);
                    cmdIns.Parameters.AddWithValue("@cid", charId);
                    cmdIns.Parameters.AddWithValue("@zid", zoneId);
                    cmdIns.Parameters.AddWithValue("@nd", nextDiff);
                    cmdIns.ExecuteNonQuery();
                }
                else
                {
                    // Varsa güncelle (Ama düşürme)
                    string upd = "UPDATE CharacterZoneData SET UnlockedDifficulty = @nd WHERE CharacterID=@cid AND ZoneID=@zid AND UnlockedDifficulty < @nd";
                    var cmdUpd = new Microsoft.Data.SqlClient.SqlCommand(upd, conn);
                    cmdUpd.Parameters.AddWithValue("@cid", charId);
                    cmdUpd.Parameters.AddWithValue("@zid", zoneId);
                    cmdUpd.Parameters.AddWithValue("@nd", nextDiff);
                    cmdUpd.ExecuteNonQuery();
                }
            }
        }
    }
}
