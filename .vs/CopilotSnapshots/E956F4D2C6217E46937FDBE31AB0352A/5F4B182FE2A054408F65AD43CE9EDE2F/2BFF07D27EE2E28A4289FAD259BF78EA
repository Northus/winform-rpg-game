using rpg_deneme.Core;
using rpg_deneme.Models;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using static System.Windows.Forms.VisualStyles.VisualStyleElement;
using rpg_deneme.Business;

namespace rpg_deneme.UI.Controls
{
    public partial class UcItemSlot : UserControl
    {
        public int SlotIndex { get; private set; }
        public ItemInstance Item { get; private set; }
        public Core.Enums.ItemType? AcceptedType { get; set; } = null;
        private Label lblCount;

        // Üst katmana (UcInventory) haber vermek için olay tanımlıyoruz
        public event EventHandler<ItemInstance> OnItemDropped;

        public UcItemSlot(int index)
        {
            InitializeComponent();
            SlotIndex = index;
            SetupDesign();
            SetupCountLabel();
            pbIcon.MouseUp += (s, e) => this.OnMouseUp(e);
            if (lblCount != null)
            {
                lblCount.MouseUp += (s, e) => this.OnMouseUp(e);
            }
        }

        private void SetupDesign()
        {
            this.Size = new Size(40, 40);
            this.BackColor = Color.FromArgb(60, 60, 60);
            this.BorderStyle = BorderStyle.FixedSingle;

            // !!! KRİTİK: Sürükle Bırak özelliğini açıyoruz !!!
            this.AllowDrop = true;

            // Olayları Bağla
            pbIcon.MouseDown += PbIcon_MouseDown;     // Sürüklemeyi Başlat
            this.DragEnter += UcItemSlot_DragEnter;   // Üzerine Gelince
            this.DragDrop += UcItemSlot_DragDrop;     // Bırakınca
        }
        private void SetupCountLabel()
        {
            lblCount = new Label();

            // 1. Şeffaflık Ayarı: Label'ı resmin üzerine 'yapıştırıyoruz'
            lblCount.Parent = pbIcon;
            lblCount.BackColor = Color.FromArgb(150, 0, 0, 0);

            // 2. Görünüm Ayarları
            lblCount.ForeColor = Color.White; // Metin rengi
            lblCount.Font = new Font("Segoe UI", 9, FontStyle.Bold); // Kalın ve okunaklı font

            // 3. Boyutlama
            lblCount.AutoSize = true; // İçindeki yazıya göre boyutu değişsin

            // Başlangıçta gizle
            lblCount.Visible = false;
        }

        // 1. Sürüklemeyi Başlat (Resme tıklayınca)
        private void PbIcon_MouseDown(object sender, MouseEventArgs e)
        {
            if (e.Button == MouseButtons.Left && Item != null)
            {
                // Sürüklenen veriyi paketle: Kendisini (ItemInstance) taşıyoruz
                pbIcon.DoDragDrop(Item, DragDropEffects.Move);
            }
        }

        // 2. Üzerine Gelince (Kabul etme efekti)
        private void UcItemSlot_DragEnter(object sender, DragEventArgs e)
        {
            if (e.Data.GetDataPresent(typeof(ItemInstance)))
            {
                var item = (ItemInstance)e.Data.GetData(typeof(ItemInstance));

                // Filtreye takılırsa "Yasak" işareti göster
                if (IsItemValidForSlot(item))
                {
                    e.Effect = DragDropEffects.Move;
                }
                else
                {
                    e.Effect = DragDropEffects.None;
                }
            }
            else
            {
                e.Effect = DragDropEffects.None;
            }
        }

        // 3. Bırakınca (İşlemi Tetikle)
        private void UcItemSlot_DragDrop(object sender, DragEventArgs e)
        {
            // Taşınan veriyi geri paketinden çıkar
            var droppedItem = (ItemInstance)e.Data.GetData(typeof(ItemInstance));

            // Bu slotun olayını tetikle (UcInventory bunu yakalayacak)
            OnItemDropped?.Invoke(this, droppedItem);
        }
        private Color GetColorByGrade(Enums.ItemGrade grade)
        {
            return grade switch
            {
                Enums.ItemGrade.Common => Color.WhiteSmoke,
                Enums.ItemGrade.Rare => Color.CornflowerBlue,
                Enums.ItemGrade.Epic => Color.MediumPurple,
                Enums.ItemGrade.Legendary => Color.Orange,
                _ => Color.Gray
            };
        }

        // ... SetItem ve diğer metotların aynen kalacak ...
        public void SetItem(ItemInstance item)
        {
            this.Item = item;

            if (item != null)
            {
                // --- 1. Renk ve İkon ---
                pbIcon.BackColor = GetColorByGrade(item.Grade);

                // --- 2. Adet Göstergesi (Count) ---
                if (item.Count > 1)
                {
                    lblCount.Text = $"{item.Count}"; // Sadece sayıyı yaz
                    lblCount.Visible = true;

                    // Biraz kenar boşluğu (Padding) bırakmak için -2 diyoruz.
                    int x = pbIcon.Width - lblCount.Width - 2;
                    int y = pbIcon.Height - lblCount.Height - 2;

                    lblCount.Location = new Point(x, y);

                    // Label'ı en öne getir (Resmin altında kalmasın)
                    lblCount.BringToFront();
                }
                else
                {
                    lblCount.Visible = false; // 1 adetse gösterme
                }

                // --- 3. İsim ve Detay (Tooltip) ---
                // İsmi slotun içine yazmak yerine gelişmiş bir Tooltip kullanıyoruz.
                string finalTooltip = GetTooltipText(item);
                toolTip1.SetToolTip(pbIcon, finalTooltip);
                toolTip1.SetToolTip(lblCount, finalTooltip);
            }
            else
            {
                // BOŞ SLOT
                pbIcon.Image = null;
                pbIcon.BackColor = Color.Transparent;
                lblCount.Visible = false;
                toolTip1.SetToolTip(pbIcon, "");
            }
        }
        public string GetTooltipText(ItemInstance item)
        {
            if (item == null) return "";

            // 1. Başlık: İsim (+upgrade) ve varsa grade (sadece ekipman)
            string text = "";

            // Name ve upgrade
            text += item.Name;
            if (item.ItemType != Core.Enums.ItemType.Consumable && item.UpgradeLevel > 0)
            {
                text += $" +{item.UpgradeLevel}";
            }

            text += "\n";

            // Tip ve kalite bilgisi
            if (item.ItemType == Core.Enums.ItemType.Consumable)
            {
                text += $"{item.ItemType}"; // "Consumable"
            }
            else
            {
                // Ekipman için kalite ve tip
                text += $"{item.Grade} | {item.ItemType}";
            }

            // Sınıf kısıtlaması
            if (item.AllowedClass.HasValue && item.AllowedClass.Value != 0)
            {
                // Eğer DB0=herkes,1..N sınıfları tutuyorsa direkt göster
                text += $" | Class: {item.AllowedClass.Value}";
            }

            text += "\n";
            text += "--------------------------\n";

            // --- HESAPLAMA ÇARPANLARI ---
            float gradeMult = StatManager.GetGradeMultiplier(item.Grade);
            float upgradeMult = StatManager.GetUpgradeMultiplier(item.UpgradeLevel);
            float totalMult = gradeMult * upgradeMult;

            // --- SİLAH İSE (Hasar Gösterimi) ---
            if (item.ItemType == Core.Enums.ItemType.Weapon)
            {
                if (item.MinDamage > 0 || item.MaxDamage > 0)
                {
                    int finalMin = (int)(item.MinDamage * totalMult);
                    int finalMax = (int)(item.MaxDamage * totalMult);
                    int bonusMin = finalMin - item.MinDamage;
                    int bonusMax = finalMax - item.MaxDamage;

                    text += $"Saldırı Gücü: {finalMin} - {finalMax}";
                    if (bonusMin > 0 || bonusMax > 0)
                    {
                        text += $" (+{bonusMin} - +{bonusMax})";
                    }
                    text += "\n";
                }

                if (item.MinMagicDamage > 0 || item.MaxMagicDamage > 0)
                {
                    int finalMagMin = (int)(item.MinMagicDamage * totalMult);
                    int finalMagMax = (int)(item.MaxMagicDamage * totalMult);
                    int bonusMagMin = finalMagMin - item.MinMagicDamage;
                    int bonusMagMax = finalMagMax - item.MaxMagicDamage;

                    text += $"Büyü Gücü: {finalMagMin} - {finalMagMax}";
                    if (bonusMagMin > 0 || bonusMagMax > 0)
                    {
                        text += $" (+{bonusMagMin} - +{bonusMagMax})";
                    }
                    text += "\n";
                }
            }
            // --- ZIRH İSE (Defans Gösterimi) ---
            else if (item.ItemType == Core.Enums.ItemType.Armor)
            {
                if (item.BaseDefense > 0)
                {
                    int finalDef = (int)(item.BaseDefense * totalMult);
                    int bonusDef = finalDef - item.BaseDefense;

                    text += $"Defans: {finalDef}";
                    if (bonusDef > 0)
                    {
                        text += $" (+{bonusDef})";
                    }
                    text += "\n";
                }
            }

            // Consumable ve diğer bilgiler
            if (item.ItemType == Core.Enums.ItemType.Consumable)
            {
                // Effect info
                if (item.EffectType != Enums.ItemEffectType.None)
                {
                    text += $"Etkisi: {item.EffectType} ({item.EffectValue})\n";
                }

                if (item.Cooldown > 0)
                {
                    text += $"Cooldown: {item.Cooldown}s";
                    int remaining = item.RemainingCooldownSeconds;
                    if (remaining > 0)
                    {
                        text += $" (Hazır: {remaining}s)\n";
                    }
                    else
                    {
                        text += "\n";
                    }
                }

                // Stack / adet bilgisi
                if (item.IsStackable && item.Count > 1)
                {
                    text += $"Adet: {item.Count}\n";
                }

                text += "Sağ Tık: Kullan\n";
            }

            return text;
        }
        private bool IsItemValidForSlot(ItemInstance item)
        {
            // 1. Genel Envanter Slotuysa her şeyi kabul et
            if (AcceptedType == null) return true;

            // 2. Ekipman Slotuysa sadece tip eşleşiyorsa kabul et
            return item.ItemType == AcceptedType.Value;
        }
    }
}
