using Microsoft.Data.SqlClient;
using rpg_deneme.Core;
using rpg_deneme.Models;
using System;
using System.Collections.Generic;

namespace rpg_deneme.Data
{
    public class InventoryRepository
    {
        public List<ItemInstance> GetCharacterInventory(int characterId)
        {
            var items = new List<ItemInstance>();

            using (var conn = DatabaseHelper.GetConnection())
            {
                // SQL Sorgusu: ItemInstances ve ItemTemplates tablolarını birleştirir
                string sql = @"
                    SELECT 
                        I.InstanceID, I.TemplateID, I.SlotIndex, I.Grade, I.Location, I.Count, I.LastUsed, 
                        I.UpgradeLevel, 
                        T.Name, T.BaseMinDamage, T.BaseMaxDamage, 
                        T.EffectType, T.EffectValue, T.Cooldown, 
                        T.ItemType, T.BaseMinMagicDamage, T.BaseMaxMagicDamage, T.BaseDefense,
                        T.ReqClass, T.IsStackable, T.MaxStack 
                    FROM ItemInstances I
                    INNER JOIN ItemTemplates T ON I.TemplateID = T.TemplateID
                    WHERE I.OwnerID = @charId";

                SqlCommand cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@charId", characterId);

                conn.Open();
                using (var dr = cmd.ExecuteReader())
                {
                    while (dr.Read())
                    {
                        items.Add(new ItemInstance
                        {
                            InstanceID = (long)dr["InstanceID"],
                            TemplateID = (int)dr["TemplateID"],
                            OwnerID = characterId,
                            SlotIndex = (int)dr["SlotIndex"],
                            Grade = (Enums.ItemGrade)(byte)dr["Grade"],
                            Location = (Enums.ItemLocation)(byte)dr["Location"],
                            Name = dr["Name"].ToString(),
                            MinDamage = dr["BaseMinDamage"] != DBNull.Value ? (int)dr["BaseMinDamage"] :0,
                            MaxDamage = dr["BaseMaxDamage"] != DBNull.Value ? (int)dr["BaseMaxDamage"] :0,
                            BaseDefense = dr["BaseDefense"] != DBNull.Value ? (int)dr["BaseDefense"] :0,
                            MinMagicDamage = dr["BaseMinMagicDamage"] != DBNull.Value ? (int)dr["BaseMinMagicDamage"] :0,
                            MaxMagicDamage = dr["BaseMaxMagicDamage"] != DBNull.Value ? (int)dr["BaseMaxMagicDamage"] :0,
                            Count = (int)dr["Count"],
                            EffectType = dr["EffectType"] != DBNull.Value ? (Enums.ItemEffectType)(byte)dr["EffectType"] : Enums.ItemEffectType.None,
                            EffectValue = dr["EffectValue"] != DBNull.Value ? (int)dr["EffectValue"] :0,
                            Cooldown = dr["Cooldown"] != DBNull.Value ? (int)dr["Cooldown"] :0,
                            LastUsed = dr["LastUsed"] == DBNull.Value ? null : (DateTime?)dr["LastUsed"],
                            ItemType = (Enums.ItemType)(byte)dr["ItemType"],
                            UpgradeLevel = dr["UpgradeLevel"] != DBNull.Value ? (int)dr["UpgradeLevel"] :0,
                            AllowedClass = dr["ReqClass"] == DBNull.Value ? (byte?)null : (byte)dr["ReqClass"],
                            IsStackable = dr["IsStackable"] != DBNull.Value ? (bool)dr["IsStackable"] : false,
                            MaxStack = dr["MaxStack"] != DBNull.Value ? (int)dr["MaxStack"] :1
                        });
                    }
                }
            }
            return items;
        }
        public bool MoveItem(long instanceId, int newSlotIndex)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                string sql = "UPDATE ItemInstances SET SlotIndex = @newSlot WHERE InstanceID = @id";
                SqlCommand cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@newSlot", newSlotIndex);
                cmd.Parameters.AddWithValue("@id", instanceId);

                conn.Open();
                return cmd.ExecuteNonQuery() >0;
            }
        }
        public void UpdateLastUsed(long instanceId)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                string sql = "UPDATE ItemInstances SET LastUsed = GETDATE() WHERE InstanceID = @id";
                SqlCommand cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@id", instanceId);
                conn.Open();
                cmd.ExecuteNonQuery();
            }
        }
        public void ConsumeItem(long instanceId, int amountToConsume)
        {
            // Fix: subtract the requested amount; if remaining <=0 delete the row.
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();

                // Get current count
                string sel = "SELECT Count FROM ItemInstances WHERE InstanceID = @id";
                SqlCommand selCmd = new SqlCommand(sel, conn);
                selCmd.Parameters.AddWithValue("@id", instanceId);
                object result = selCmd.ExecuteScalar();

                if (result == null || result == DBNull.Value)
                {
                    // Nothing to do
                    return;
                }

                int currentCount = Convert.ToInt32(result);

                if (currentCount > amountToConsume)
                {
                    string upd = "UPDATE ItemInstances SET Count = Count - @amt WHERE InstanceID = @id";
                    SqlCommand updCmd = new SqlCommand(upd, conn);
                    updCmd.Parameters.AddWithValue("@amt", amountToConsume);
                    updCmd.Parameters.AddWithValue("@id", instanceId);
                    updCmd.ExecuteNonQuery();
                }
                else
                {
                    string del = "DELETE FROM ItemInstances WHERE InstanceID = @id";
                    SqlCommand delCmd = new SqlCommand(del, conn);
                    delCmd.Parameters.AddWithValue("@id", instanceId);
                    delCmd.ExecuteNonQuery();
                }
            }
        }
        public bool MoveItemLocation(long instanceId, Core.Enums.ItemLocation newLoc, int newSlot)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                string sql = "UPDATE ItemInstances SET Location = @loc, SlotIndex = @slot WHERE InstanceID = @id";

                SqlCommand cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@loc", (byte)newLoc);
                cmd.Parameters.AddWithValue("@slot", newSlot);
                cmd.Parameters.AddWithValue("@id", instanceId);

                conn.Open();
                return cmd.ExecuteNonQuery() >0;
            }
        }
        public int FindFirstEmptyInventorySlot(int characterId)
        {
            var usedSlots = new HashSet<int>();

            using (var conn = DatabaseHelper.GetConnection())
            {
                string sql = "SELECT SlotIndex FROM ItemInstances WHERE OwnerID = @charId AND Location =1";

                SqlCommand cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@charId", characterId);

                conn.Open();
                using (var dr = cmd.ExecuteReader())
                {
                    while (dr.Read())
                    {
                        if (dr["SlotIndex"] != DBNull.Value)
                        {
                            usedSlots.Add((int)dr["SlotIndex"]);
                        }
                    }
                }
            }
            for (int i =0; i <40; i++)
            {
                if (!usedSlots.Contains(i))
                {
                    return i;
                }
            }
            return -1;
        }
        public ItemInstance GetItemAt(int characterId, Core.Enums.ItemLocation loc, int slotIndex)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                string sql = "SELECT * FROM ItemInstances WHERE OwnerID=@charId AND Location=@loc AND SlotIndex=@slot";
                SqlCommand cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@charId", characterId); // Parametre adı düzeltildi
                cmd.Parameters.AddWithValue("@loc", (byte)loc);
                cmd.Parameters.AddWithValue("@slot", slotIndex);

                conn.Open();
                using (var dr = cmd.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        return new ItemInstance
                        {
                            InstanceID = (long)dr["InstanceID"],
                            OwnerID = characterId,
                            Location = loc,
                            SlotIndex = slotIndex
                        };
                    }
                }
            }
            return null;
        }

        // Yeni: template'ten ItemType, AllowedClass ve IsStackable bilgilerini getirir
        public (Enums.ItemType ItemType, byte? AllowedClass, bool IsStackable) GetTemplateInfo(int templateId)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                string sql = "SELECT ItemType, ReqClass, IsStackable FROM ItemTemplates WHERE TemplateID = @tid";
                SqlCommand cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@tid", templateId);
                conn.Open();
                using (var dr = cmd.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        var it = (Enums.ItemType)(byte)dr["ItemType"];
                        byte? allowed = dr["ReqClass"] == DBNull.Value ? (byte?)null : (byte)dr["ReqClass"];
                        // Basit ve güvenli versiyon
                        bool stk = dr["IsStackable"] != DBNull.Value ? (bool)dr["IsStackable"] : false;

                        // Daha performanslı ve okunur: sütun indekslerini kullanarak tip güvenli okuma
                        int idxIsStackable = dr.GetOrdinal("IsStackable");
                        bool stk2 = !dr.IsDBNull(idxIsStackable) && dr.GetBoolean(idxIsStackable);

                        return (it, allowed, stk);
                    }
                }
            }
            // Varsayılan: bulunamazsa Weapon, izinsiz null, stack false
            return (Enums.ItemType.Weapon, null, false);
        }

        // Yeni: envanterde aynı template için, inventory konumunda mevcut bir stack var mı getir
        public ItemInstance FindStackableItem(int characterId, int templateId)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                string sql = "SELECT InstanceID, Count, SlotIndex FROM ItemInstances WHERE OwnerID=@charId AND TemplateID=@tid AND Location=@loc";
                SqlCommand cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@charId", characterId);
                cmd.Parameters.AddWithValue("@tid", templateId);
                cmd.Parameters.AddWithValue("@loc", (byte)Enums.ItemLocation.Inventory);

                conn.Open();
                using (var dr = cmd.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        return new ItemInstance
                        {
                            InstanceID = (long)dr["InstanceID"],
                            Count = (int)dr["Count"],
                            SlotIndex = (int)dr["SlotIndex"],
                            OwnerID = characterId,
                            TemplateID = templateId,
                            Location = Enums.ItemLocation.Inventory
                        };
                    }
                }
            }
            return null;
        }

        // Yeni: mevcut item'ın Count değerini artır
        public bool IncrementItemCount(long instanceId, int add)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                string sql = "UPDATE ItemInstances SET Count = Count + @add WHERE InstanceID = @id";
                SqlCommand cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@add", add);
                cmd.Parameters.AddWithValue("@id", instanceId);
                conn.Open();
                return cmd.ExecuteNonQuery() >0;
            }
        }
        // Data/InventoryRepository.cs

        public ItemInstance FindStackableItemWithCapacity(int characterId, int templateId, int maxStack)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                // Count değeri MaxStack'ten KÜÇÜK olan bir kayıt arıyoruz.
                string sql = @"
                SELECT TOP 1 InstanceID, Count, SlotIndex
                FROM ItemInstances
                WHERE OwnerID = @charId
                AND TemplateID = @tid
                AND Location = @loc
                AND Count < @maxStack"; // KRİTİK KONTROL

                SqlCommand cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@charId", characterId);
                cmd.Parameters.AddWithValue("@tid", templateId);
                cmd.Parameters.AddWithValue("@loc", (byte)Enums.ItemLocation.Inventory);
                cmd.Parameters.AddWithValue("@maxStack", maxStack);

                conn.Open();
                using (var dr = cmd.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        return new ItemInstance
                        {
                            InstanceID = (long)dr["InstanceID"],
                            Count = (int)dr["Count"],
                            SlotIndex = (int)dr["SlotIndex"],
                            OwnerID = characterId,
                            TemplateID = templateId
                        };
                    }
                }
            }
            return null;
        }
        public bool AddItemDirectly(ItemInstance item)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                string sql = @"INSERT INTO ItemInstances (TemplateID, OwnerID, SlotIndex, Grade, Location, Count) 
                       VALUES (@tid, @oid, @slot, @grade, @loc, @count)";
                SqlCommand cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@tid", item.TemplateID);
                cmd.Parameters.AddWithValue("@oid", item.OwnerID);
                cmd.Parameters.AddWithValue("@slot", item.SlotIndex);
                cmd.Parameters.AddWithValue("@grade", (byte)item.Grade);
                cmd.Parameters.AddWithValue("@loc", (byte)item.Location);
                cmd.Parameters.AddWithValue("@count", item.Count);
                return cmd.ExecuteNonQuery() >0;
            }
        }

        public (Enums.ItemType ItemType, bool IsStackable, int MaxStack, string Name) GetTemplateBasicInfo(int templateId)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                string sql = "SELECT ItemType, IsStackable, MaxStack, Name FROM ItemTemplates WHERE TemplateID = @tid";
                SqlCommand cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@tid", templateId);
                conn.Open();
                using (var dr = cmd.ExecuteReader())
                {
                    if (dr.Read())
                    {
                        var it = (Enums.ItemType)(byte)dr["ItemType"];
                        bool stk = dr["IsStackable"] != DBNull.Value && (bool)dr["IsStackable"];
                        int max = dr["MaxStack"] != DBNull.Value ? (int)dr["MaxStack"] :1;
                        string name = dr["Name"] != DBNull.Value ? dr["Name"].ToString() : string.Empty;
                        return (it, stk, max, name);
                    }
                }
            }
            return (Enums.ItemType.Weapon, false,1, string.Empty);
        }
        public List<ItemInstance> GetSharedStorageItems()
        {
            var items = new List<ItemInstance>();
            using (var conn = DatabaseHelper.GetConnection())
            {
                // OwnerID filtresini kaldırdık, sadece Location = 3 (Storage)
                string sql = @"
                SELECT 
                    I.InstanceID, I.TemplateID, I.SlotIndex, I.Grade, I.Location, I.Count, I.LastUsed, I.UpgradeLevel, 
                    I.OwnerID, -- Sahibini de çekelim
                    T.Name, T.BaseMinDamage, T.BaseMaxDamage, T.EffectType, T.EffectValue, T.Cooldown, 
                    T.ItemType, T.BaseMinMagicDamage, T.BaseMaxMagicDamage, T.BaseDefense,
                    T.ReqClass, T.IsStackable, T.MaxStack 
                FROM ItemInstances I
                INNER JOIN ItemTemplates T ON I.TemplateID = T.TemplateID
                WHERE I.Location = 3"; // 3 = Storage

                SqlCommand cmd = new SqlCommand(sql, conn);
                conn.Open();
                using (var dr = cmd.ExecuteReader())
                {
                    while (dr.Read())
                    {
                        items.Add(new ItemInstance
                        {
                            InstanceID = (long)dr["InstanceID"],
                            TemplateID = (int)dr["TemplateID"],
                            OwnerID = (int)dr["OwnerID"],
                            SlotIndex = (int)dr["SlotIndex"],
                            Grade = (Enums.ItemGrade)(byte)dr["Grade"],
                            Location = (Enums.ItemLocation)(byte)dr["Location"],
                            Count = (int)dr["Count"],
                            Name = dr["Name"].ToString(),
                            // ... Diğer özellikler (Hasar, Defans vb.) InventoryRepository'deki ile aynı ...
                            // Kısaltmak için diğer özellikleri buraya kopyaladığını varsayıyorum
                            ItemType = (Enums.ItemType)(byte)dr["ItemType"],
                            IsStackable = dr["IsStackable"] != DBNull.Value && (bool)dr["IsStackable"],
                            MaxStack = dr["MaxStack"] != DBNull.Value ? (int)dr["MaxStack"] : 1
                            // NOT: InventoryRepository'deki GetCharacterInventory metodundaki tüm maplemeleri buraya da eklemelisin.
                        });
                    }
                }
            }
            return items;
        }
        public void UpdateItemOwner(long instanceId, int newOwnerId)
        {
            using (var conn = DatabaseHelper.GetConnection())
            {
                string sql = "UPDATE ItemInstances SET OwnerID = @oid WHERE InstanceID = @id";
                SqlCommand cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@oid", newOwnerId);
                cmd.Parameters.AddWithValue("@id", instanceId);
                conn.Open();
                cmd.ExecuteNonQuery();
            }
        }
    }
}