using rpg_deneme.Business;
using rpg_deneme.Models;
using rpg_deneme.UI;
using rpg_deneme.UI.Controls;
using rpg_deneme.UI.Windows;
using System.Data; // Linq için gerekli olabilir

namespace rpg_deneme
{
    public partial class FormMain : Form
    {
        private Models.CharacterModel _hero;
        private InventoryManager _invManager = new InventoryManager();
        private UcArena _townArena;

        private UcMerchant _ucMerchant;


        public FormMain()
        {
            InitializeComponent();
            this.KeyPreview = true;
        }

        private void FormMain_Load(object sender, EventArgs e)
        {
            // 1. Karakteri hafızadan yükle
            _hero = Core.SessionManager.CurrentCharacter;

            if (_hero == null) return;

            // Başlangıçta pencereleri gizle
            ucInventory1.Visible = false;
            ucStats1.Visible = false;
            ucInventory1.OnSellRequest += (s, item) => SellItemProcess(item);

            // 2. EKRANI GÜNCELLE
            UpdateUI();

            ShowTown();
        }
        // Ekran Değiştirme Yardımcısı
        private void SwitchScreen(UserControl newScreen)
        {
            pnlMainContent.Controls.Clear(); // Eskiyi sil
            _currentScreen = newScreen;
            newScreen.Dock = DockStyle.Fill;
            pnlMainContent.Controls.Add(newScreen); // Yeniyi ekle

            // Whenever switching screens, disable merchant-selling mode unless merchant UI is explicitly shown
            ucInventory1.IsMerchantMode = false;
        }

        public void ShowZoneMap()
        {
            var mapScreen = new UcZoneMap();

            // 1. Zone Seçilirse -> Keşif Ekranına Git
            mapScreen.OnZoneSelected += (s, zone) =>
            {
                ShowExploration(zone);
            };

            // 2. Köy İstenirse -> Köye Git (YENİ)
            mapScreen.OnTownRequested += (s, e) =>
            {
                ShowTown();
            };

            SwitchScreen(mapScreen);
        }
        public void ShowTown()
        {
            // Eğer daha önce oluşturulmadıysa oluştur
            if (_townArena == null)
            {
                _townArena = new UcArena();
                _townArena.Dock = DockStyle.Fill;

                // NPC Etkileşimini Dinle
                _townArena.OnNpcInteraction += (s, npc) =>
                {
                    if (npc.Type == Core.Enums.NpcType.Teleporter)
                    {
                        // Işınlayıcıya sağ tıkladı -> Haritayı Aç
                        ShowZoneMap();
                    }
                    else if (npc.Type == Core.Enums.NpcType.Merchant)
                    {
                        // Market Açıksa kapat
                        if (_ucMerchant != null && _ucMerchant.Visible)
                        {
                            _ucMerchant.Visible = false;
                            ucInventory1.IsMerchantMode = false; // Modu kapat
                            return;
                        }

                        // Market Oluştur (Singleton gibi davranabiliriz veya her seferinde new)
                        if (_ucMerchant == null)
                        {
                            //1. Market ID'si ile oluştur
                            int shopId =1;
                            _ucMerchant = new UcMerchant(shopId);

                            _ucMerchant.Location = new Point(ucInventory1.Right +10, ucInventory1.Top);
                            pnlMainContent.Controls.Add(_ucMerchant);

                            // Olayları Bağla
                            _ucMerchant.OnInventoryUpdateNeeded += (sender, args) => RefreshStats();
                            _ucMerchant.OnSellRequested += (sender, item) => SellItemProcess(item);
                            _ucMerchant.VisibleChanged += (sender, args) =>
                            {
                                // Market görünürse -> Satış Modu AÇIK (True)
                                // Market gizliyse -> Satış Modu KAPALI (False)
                                ucInventory1.IsMerchantMode = _ucMerchant.Visible;

                                // Eğer marketi X ile kapattıysak, envanteri de kapatmak istersen:
                                // if (!_ucMerchant.Visible) ucInventory1.Visible = false; // (Opsiyonel)
                            };
                        }

                        if (_ucMerchant.Visible)
                        {
                            _ucMerchant.Visible = false;
                            // VisibleChanged olayı tetiklenecek ve IsMerchantMode = false olacak.
                        }
                        else
                        {
                            // Değilse -> AÇ
                            ucInventory1.Visible = true;
                            ucInventory1.BringToFront();

                            _ucMerchant.Visible = true;
                            _ucMerchant.BringToFront();
                            // VisibleChanged olayı tetiklenecek ve IsMerchantMode = true olacak.

                            MessageBox.Show($"Hoşgeldin {_hero.Name}! Neye ihtiyacın var?");
                        }
                    }
                };
            }

            // First switch screen so UcArena has a parent and real size
            SwitchScreen(_townArena);

            // Then start town logic (positions/layout rely on having a parent)
            _townArena.StartTown(_hero);
        }

        public void SellItemProcess(ItemInstance item)
        {
            // 1. MANAGER TANIMI (Yerel Değişken)
            var shopManager = new ShopManager();

            int qty = item.Count;

            // Miktar Sorma (Dialog)
            if (item.IsStackable && item.Count > 1)
            {
                using (var qd = new QuantityDialog(item.Count))
                {
                    if (qd.ShowDialog() == DialogResult.OK)
                        qty = qd.SelectedQuantity;
                    else return;
                }
            }

            // 2. FİYAT SORGULAMA (Local değişken 'shopManager' kullanıyoruz)
            int unitSellPrice = shopManager.GetSellPrice(item.TemplateID);

            if (unitSellPrice <= 0) unitSellPrice = 1;

            long totalEarn = (long)unitSellPrice * qty;

            var confirm = MessageBox.Show(
                $"{qty} adet {item.Name} satılacak.\nKazanılacak: {totalEarn} Altın\nOnaylıyor musun?",
                "Satış", MessageBoxButtons.YesNo);

            if (confirm == DialogResult.Yes)
            {
                // 3. PARAMETRE DÜZELTMESİ (Sadece 3 tane: Hero, Item, Qty)
                // totalEarn parametresi ARTIK YOK, çünkü manager kendi içinde hesaplıyor.
                var result = shopManager.SellItem(_hero, item, qty);

                if (result.Success)
                {
                    RefreshStats();
                    MessageBox.Show(result.Message);
                }
            }
        }

        public void ShowExploration(ZoneModel zone)
        {
            var exploreScreen = new UcExploration(zone);

            exploreScreen.OnReturnRequested += (s, e) =>
            {
                ShowZoneMap();
            };
            // ---------------------------

            SwitchScreen(exploreScreen);
        }

        // --- KLAVYE YÖNLENDİRMESİ ---
        // Tuşlara basılınca aktif ekran "Keşif Ekranı" ise ve savaş varsa ona ilet
        protected override void OnKeyDown(KeyEventArgs e)
        {
            // Keşif ekranı aktifse ona yolla
            if (_currentScreen is UcExploration explore)
            {
                explore.RelayKeyDown(e.KeyCode);
            }
            // KÖY ekranı aktifse ona yolla
            else if (_currentScreen is UcArena arena)
            {
                // WASD movement + other keys
                arena.HandleKeyDown(e.KeyCode);

                // Hotbar numeric keys (1-5)
                if (e.KeyCode >= Keys.D1 && e.KeyCode <= Keys.D5)
                {
                    arena.HandleHotbarKey(e.KeyCode);
                    e.Handled = true;
                }
                else if (e.KeyCode >= Keys.NumPad1 && e.KeyCode <= Keys.NumPad5)
                {
                    arena.HandleHotbarKey(e.KeyCode);
                    e.Handled = true;
                }
            }

            base.OnKeyDown(e);
        }

        protected override void OnKeyUp(KeyEventArgs e)
        {
            if (_currentScreen is UcExploration explore)
            {
                explore.RelayKeyUp(e.KeyCode);
            }
            else if (_currentScreen is UcArena arena)
            {
                arena.HandleKeyUp(e.KeyCode);
            }

            base.OnKeyUp(e);
        }

        // --- BUTONLAR ---

        private void btnInventory_Click(object sender, EventArgs e)
        {
            ucInventory1.Visible = !ucInventory1.Visible;
            if (ucInventory1.Visible) ucInventory1.BringToFront();
        }

        private void btnStats_Click(object sender, EventArgs e)
        {
            ucStats1.Visible = !ucStats1.Visible;
            if (ucStats1.Visible)
            {
                ucStats1.BringToFront();
                ucStats1.LoadData(); // Açılınca verileri tazele
            }
        }

        // --- GÜNCELLEME METOTLARI ---

        public void UpdateUI()
        {
            // Bu metot sadece temel arayüzü (Bar, İsim) güncellesin
            // Envanter ve Stat güncellemesi RefreshStats içinde veya ayrı yapılabilir
            // Ama burada çağırmak da mantıklı.

            lblCharName.Text = _hero.Name;

            // Envanteri yükle
            // Not: Envanter kapalıysa boşuna yükleme yapmayabilirsin ama şimdilik kalsın.
            var myItems = _invManager.GetInventory(_hero.CharacterID);
            ucInventory1.LoadItems(myItems);

            // Eğer stat penceresi açıksa onu da güncelle
            if (ucStats1.Visible) ucStats1.LoadData();
            UpdateBars();
        }

        public void RefreshStats()
        {
            // 1. Karakter verisini tazele (Puan verince falan değişiyor çünkü)
            _hero = Core.SessionManager.CurrentCharacter;
            if (_hero == null) return;

            // 2. Eşyaları Çek
            var allItems = _invManager.GetInventory(_hero.CharacterID);
            var equipment = allItems.Where(x => x.Location == Core.Enums.ItemLocation.Equipment).ToList();
            var weapon = equipment.FirstOrDefault(x => x.ItemType == Core.Enums.ItemType.Weapon);

            // 3. STAT MANAGER İLE HESAPLA (Sadece Debug veya Label gösterimi için)
            // Asıl gösterim UcStats içinde yapılıyor.

            // Eğer ana ekranda (FormMain) hasar yazan bir label varsa burayı aç:
            /*
            int phyDmg = StatManager.CalculatePhysicalDamage(_hero, weapon);
            int totalDef = StatManager.CalculateTotalDefense(_hero, equipment);
            lblDmg.Text = $"Hasar: {phyDmg}";
            */

            // 4. KRİTİK NOKTA: UCSTATS'I GÜNCELLE
            // Eğer pencere açıksa LoadData metodunu çağır ki yeni değerleri hesaplayıp göstersin.
            if (ucStats1.Visible)
            {
                ucStats1.LoadData();
            }

            // 5. Envanteri de yenile (Eşya yer değiştirdi)
            // Sadece Inventory konumundakileri değil, LoadItems hepsini alıp ayırıyor zaten.
            ucInventory1.LoadItems(allItems);
            ucInventory1.UpdateGoldLabel();
            UpdateBars();
            // Senaryo A: Keşif Ekranındaysak (Savaş Arenası)
            if (_currentScreen is UcExploration exploreScreen)
            {
                exploreScreen.RefreshBattleStats();
            }
            // Senaryo B: Köydeysek (Town Arena)
            else if (_currentScreen is UcArena townArena) // _townArena nesnesi
            {
                townArena.RecalculatePlayerStats();
            }
        }
        private UserControl _currentScreen;
        // Barları Güncelleme Metodu
        public void UpdateBars()
        {
            if (_hero == null) return;

            // 1. MAX DEĞERLERİ HESAPLA
            int maxHP = StatManager.CalculateMaxHP(_hero.VIT, _hero.Level);
            int maxMana = StatManager.CalculateMaxMana(_hero.INT, _hero.Level);
            int requiredExp = LevelManager.GetRequiredXp(_hero.Level);

            // 2. CAN BARI (HP)
            // Eğer mevcut can, max candan büyükse (level atlayınca vs.) eşitle
            if (_hero.HP > maxHP) _hero.HP = maxHP;

            // Özel ProgressBar Ayarları
            pbHP.Maximum = maxHP;
            pbHP.Value = Math.Max(0, _hero.HP);
            pbHP.BarColor = Color.Crimson; // Kırmızı Can Barı

            // 3. MANA BARI
            if (_hero.Mana > maxMana) _hero.Mana = maxMana;

            pbMana.Maximum = maxMana;
            pbMana.Value = Math.Max(0, _hero.Mana);
            pbMana.BarColor = Color.DodgerBlue; // Mavi Mana Barı

            // 4. EXP BARI
            pbExp.Maximum = requiredExp;
            pbExp.Value = Math.Min(requiredExp, Math.Max(0, _hero.Experience));
            pbExp.BarColor = Color.Gold; // Sarı XP Barı
            pbExp.ShowPercentage = true; // İstersen XP'yi % olarak göster

            // Level Label'ı
            if (lblLevel != null) lblLevel.Text = $"Level {_hero.Level}";
        }
    }

}