using Microsoft.Data.SqlClient;
using rpg_deneme.Data; // Repository'ye erişmek için
using rpg_deneme.Models; // ItemInstance modelini tanımak için
using System.Collections.Generic; // List<> kullanabilmek için

namespace rpg_deneme.Business
{
    public class InventoryManager
    {
        // Data katmanındaki (SQL işlerini yapan) sınıfı burada tanımlıyoruz.
        // "private readonly" demek: Bu sınıf sadece burada kullanılacak ve değiştirilemeyecek.
        private readonly InventoryRepository _repo = new InventoryRepository();

        /// <summary>
        /// Karakterin ID'sine göre üzerindeki eşyaları getirir.
        /// </summary>
        public List<ItemInstance> GetInventory(int charId)
        {
            // Business katmanı olarak Data katmanına emri veriyoruz:
            // "Git bana bu karakterin eşyalarını SQL'den çek getir."
            return _repo.GetCharacterInventory(charId);
        }
        public bool MoveItemToSlot(long instanceId, int targetSlotIndex)
        {
            // İleride buraya kural ekleyebiliriz (Örn: Çanta kilitli mi?)
            return _repo.MoveItem(instanceId, targetSlotIndex);
        }
        // Eşyayı hem konum (Equipment/Inventory) hem de slot olarak taşır.
        // Özellikle "Üzerimden çıkarıp çantanın şu kutusuna koy" dediğimizde kullanılır.
        public bool MoveItemToSlotAndLocation(long instanceId, Core.Enums.ItemLocation newLocation, int targetSlotIndex)
        {
            // Repository'deki MoveItemLocation metodunu çağırır
            return _repo.MoveItemLocation(instanceId, newLocation, targetSlotIndex);
        }

        // AddItemToInventory artık stackleme ve consumable-grade mantığını içerir
        public bool AddItemToInventory(ItemInstance item)
        {
            // Template bilgilerini al
            var templateInfo = _repo.GetTemplateInfo(item.TemplateID);

            // Eğer template stackleniyorsa ve inventory'de varsa direkt adeti artır
            if (templateInfo.IsStackable)
            {
                item.Grade = Core.Enums.ItemGrade.Consumable; // Tüketilebilir tiplerde grade yok gibi davran
                var existing = _repo.FindStackableItem(item.OwnerID, item.TemplateID);
                if (existing != null)
                {
                    return _repo.IncrementItemCount(existing.InstanceID, item.Count);
                }
            }

            //1. Boş slot bul
            int emptySlot = _repo.FindFirstEmptyInventorySlot(item.OwnerID);
            if (emptySlot == -1) return false; // Yer yok

            item.SlotIndex = emptySlot;

            //2. Veritabanına INSERT et
            using (var conn = DatabaseHelper.GetConnection())
            {
                conn.Open();
                string sql = @"
                INSERT INTO ItemInstances 
                (TemplateID, OwnerID, SlotIndex, Grade, Location, Count, UpgradeLevel) 
                VALUES 
                (@tid, @oid, @slot, @grade, @loc, @count, @upg)";

                SqlCommand cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@tid", item.TemplateID);
                cmd.Parameters.AddWithValue("@oid", item.OwnerID);
                cmd.Parameters.AddWithValue("@slot", item.SlotIndex);
                cmd.Parameters.AddWithValue("@grade", (byte)item.Grade);
                cmd.Parameters.AddWithValue("@loc", (byte)item.Location);
                cmd.Parameters.AddWithValue("@count", item.Count);
                cmd.Parameters.AddWithValue("@upg", item.UpgradeLevel);

                return cmd.ExecuteNonQuery() > 0;
            }
        }
    }
}