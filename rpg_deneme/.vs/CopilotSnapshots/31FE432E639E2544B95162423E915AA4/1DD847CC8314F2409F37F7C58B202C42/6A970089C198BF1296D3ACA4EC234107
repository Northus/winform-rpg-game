using System;
using System.Collections.Generic;
using System.Linq;
using rpg_deneme.Models;

namespace rpg_deneme.Business
{
    public class SkillManager
    {
        // Geçici veritabanı benzeri skill listesi
        private static List<SkillModel> _allSkills = new List<SkillModel>();

        static SkillManager()
        {
            InitializeSkills();
        }

        private static void InitializeSkills()
        {
            // Örnek Skiller
            _allSkills.Add(new SkillModel
            {
                Id = 1,
                Name = "Ateş Topu",
                Description = "Hedefe bir ateş topu fırlatır.",
                ManaCost = 10,
                CooldownSeconds = 1.0,
                Type = SkillType.Projectile,
                BasePower = 20,
                IconColor = System.Drawing.Color.OrangeRed
            });

            _allSkills.Add(new SkillModel
            {
                Id = 2,
                Name = "Hızlı Saldırı",
                Description = "Yakın mesafe hızlı bir darbe.",
                ManaCost = 5,
                CooldownSeconds = 0.5,
                Type = SkillType.Melee,
                BasePower = 15,
                IconColor = System.Drawing.Color.WhiteSmoke
            });

            _allSkills.Add(new SkillModel
            {
                Id = 3,
                Name = "İyileştirme",
                Description = "Kendini iyileştirir.",
                ManaCost = 25,
                CooldownSeconds = 5.0,
                Type = SkillType.Heal,
                BasePower = 30,
                IconColor = System.Drawing.Color.LightGreen
            });
        }

        public List<SkillModel> GetAllSkills()
        {
            return _allSkills;
        }

        public SkillModel GetSkillById(int id)
        {
            return _allSkills.FirstOrDefault(s => s.Id == id);
        }

        /// <summary>
        /// Karakterin manası yetiyor mu ve cooldown uygun mu kontrolü.
        /// (Cooldown takibi UI tarafında veya Session'da tutulmalı, burada sadece statik kontrol örnek)
        /// </summary>
        public bool CheckManaCost(CharacterModel caster, SkillModel skill)
        {
            if (caster == null || skill == null) return false;
            return caster.Mana >= skill.ManaCost;
        }

        /// <summary>
        /// Hasar hesaplaması. 
        /// Modüler olması için Entity'den gelen statları parametre alabilir.
        /// </summary>
        public int CalculateDamage(SkillModel skill, int casterInt, int casterStr, int critChance, out bool isCritical)
        {
            // Basit bir formül
            int damage = skill.BasePower;

            if (skill.Type == SkillType.Projectile || skill.Type == SkillType.AreaEffect || skill.Type == SkillType.Heal)
            {
                // Büyü gücü (INT) etkisi
                damage += casterInt * 2;
            }
            else if (skill.Type == SkillType.Melee)
            {
                // Fiziksel güç (STR) etkisi
                damage += casterStr * 2;
            }

            // Critical Hit Check
            Random rnd = new Random();
            isCritical = (rnd.Next(100) < critChance);
         
            if (isCritical && skill.Type != SkillType.Heal)
            {
                damage = (int)(damage * 1.5f); // %50 bonus on crit
            }

            return damage;
        }
    }
}
